<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Twin.ai - Chatbot</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      background-color: #ffffff;
      color: #000;
      transition: 0.3s;
    }

    body.dark {
      background-color: #1e1e1e;
      color: #f5f5f5;
    }

    .sidebar {
      width: 220px;
      padding: 1rem;
      background: #f3f3f3;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    body.dark .sidebar {
      background: #2a2a2a;
    }

    .mode-box {
      background: white;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: 0.3s;
    }

    .mode-box.active {
      border-color: #10a37f;
      background: #e6f9f4;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      padding: 10px 20px;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      border-radius: 34px;
      transition: 0.4s;
    }

    .slider:before {
      content: "";
      height: 18px;
      width: 18px;
      position: absolute;
      left: 4px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.4s;
    }

    input:checked + .slider {
      background-color: #10a37f;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    #chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f0f0f0;
    }

    .box {
      margin-bottom: 10px;
      padding: 12px;
      border-radius: 10px;
      max-width: 80%;
    }

    .box.user {
      background-color: #c4dbfe;
      align-self: flex-end;
    }

    .box.answer {
      background-color: #d2ffe9;
    }

    .input-area {
      display: flex;
      padding: 10px;
      background-color: #f0f0f0;
    }

    textarea {
      flex: 1;
      resize: none;
      font-size: 16px;
      padding: 10px;
    }

    button {
      background-color: #10a37f;
      color: white;
      border: none;
      padding: 10px;
      margin-left: 5px;
      border-radius: 5px;
      cursor: pointer;
    }

    #mic-btn {
      background-color: #ff6b6b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
    }

    #mic-btn.recording {
      background-color: #e74c3c;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="mode-box active" data-mode="focus">üîî Focus Buddy</div>
    <div class="mode-box" data-mode="chill">üòé Chill Chat</div>
    <div class="mode-box" data-mode="life">üå± Life Coach</div>
    <div class="mode-box" data-mode="dev">üë®‚Äçüíª Dev Helper</div>
  </div>

  <div class="main">
    <div class="header">
      <h2>Twin.ai</h2>
      <label class="toggle-switch">
        <input type="checkbox" id="theme-toggle" />
        <span class="slider"></span>
      </label>
    </div>
    <div id="chat-area" class="chat-wrapper"></div>

    <div class="input-area">
      <textarea id="input" rows="1" placeholder="Say or type something..."></textarea>
      <button id="btn">‚û§</button>
      <button id="mic-btn">üé§</button>
    </div>
  </div>

  <script>
    const input = document.getElementById("input");
    const btn = document.getElementById("btn");
    const micBtn = document.getElementById("mic-btn");
    const chatArea = document.getElementById("chat-area");
    const themeToggle = document.getElementById("theme-toggle");
    const modeBoxes = document.querySelectorAll(".mode-box");

    let mode = "focus";
    let messages = [];

    const Humanise = " Speak naturally and conversationally like a human. Use pauses and short paragraphs. Keep the answers short and crisp, as per the user demands nut by default keep it short and crisp. Avoid robotic or overly formal language also avoid internal dialogues like `thinking`,`laughs` etc."

    const modePrompts = {
      focus: {
        intro: "üîî I'm your Focus Buddy. Let's crush those tasks!",
        prompt: "You are a productivity coach. Help users stay focused and avoid distractions." + Humanise
      },
      chill: {
        intro: "üòé Hey! I‚Äôm your Chill Chat buddy. Let's just vibe.",
        prompt: "You are a casual chat companion, talk freely and lightly." + Humanise
      },
      life: {
        intro: "üå± I'm your Life Coach. Let's set goals and grow.",
        prompt: "You are a motivating life coach who helps people improve." + Humanise
      },
      dev: {
        intro: "üë®‚Äçüíª Dev Helper here! Ask me anything about code.",
        prompt: "You are a professional programming assistant for developers." + Humanise
      }
    };

    const showIntro = () => {
      chatArea.innerHTML = "";
      const intro = document.createElement("div");
      intro.className = "box answer";
      intro.textContent = modePrompts[mode].intro;
      chatArea.appendChild(intro);
      messages = [{ role: "system", content: modePrompts[mode].prompt }];
    };

    modeBoxes.forEach(box => {
      box.addEventListener("click", () => {
        modeBoxes.forEach(b => b.classList.remove("active"));
        box.classList.add("active");
        mode = box.dataset.mode;
        showIntro();
      });
    });

    themeToggle.addEventListener("change", () => {
      document.body.classList.toggle("dark");
    });

    window.addEventListener("DOMContentLoaded", showIntro);

    btn.addEventListener("click", async () => {
      const inputText = input.value.trim();
      if (!inputText) return;

      const userBox = document.createElement("div");
      userBox.className = "box user";
      userBox.textContent = inputText;
      chatArea.appendChild(userBox);
      chatArea.scrollTop = chatArea.scrollHeight;

      messages.push({ role: "user", content: inputText });
      input.value = "";

      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      const data = await res.json();
      const reply = data.message || "No response.";
      messages.push({ role: "assistant", content: reply });

      const botBox = document.createElement("div");
      botBox.className = "box answer";
      chatArea.appendChild(botBox);
      chatArea.scrollTop = chatArea.scrollHeight;

      const words = reply.split(" ");
      let i = 0;
      const typeEffect = () => {
        if (i < words.length) {
          botBox.textContent += words[i++] + " ";
          chatArea.scrollTop = chatArea.scrollHeight;
          setTimeout(typeEffect, 30);
        }
      };
      typeEffect();

      const tts = await fetch("/speak", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: reply })
      });

      const blob = await tts.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play();
    });

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    recognition.onstart = () => micBtn.classList.add("recording");
    recognition.onend = () => micBtn.classList.remove("recording");
    recognition.onerror = e => console.error("Speech error:", e);
    recognition.onresult = (event) => {
      const speech = event.results[0][0].transcript;
      input.value = speech;
      btn.click();
    };

    micBtn.addEventListener("click", () => recognition.start());
  </script>
</body>
</html>
